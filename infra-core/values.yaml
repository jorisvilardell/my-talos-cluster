# Argo CD subchart values
argo-cd:
  # --- Configuration Haute Disponibilité (HA) ---
  redis-ha:
    enabled: true
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"
    haproxy:
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"

  controller:
    replicas: 2

  server:
    replicas: 2
    ingress:
      enabled: false

  repoServer:
    replicas: 2
    env:
      - name: XDG_CONFIG_HOME
        value: /.config
      - name: SOPS_AGE_KEY_FILE
        value: /.config/sops/age/keys.txt
    volumes:
      - name: custom-tools
        emptyDir: {}
      - name: sops-age
        secret:
          secretName: sops-age-key
    initContainers:
      - name: install-ksops
        image: viaductoss/ksops:v4.3.3
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
          - echo "Installing KSOPS...";
            cp /usr/local/bin/ksops /custom-tools/;
            cp /usr/local/bin/kustomize /custom-tools/;
            echo "Done.";
        volumeMounts:
          - mountPath: /custom-tools
            name: custom-tools
    volumeMounts:
      - mountPath: /usr/local/bin/kustomize
        name: custom-tools
        subPath: kustomize
      - mountPath: /usr/local/bin/ksops
        name: custom-tools
        subPath: ksops
      - mountPath: /.config/sops/age
        name: sops-age
      - mountPath: /.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops
        name: custom-tools
        subPath: ksops

  applicationSet:
    replicas: 2

  # --- Tolérances pour tourner sur les Control Planes ---
  global:
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"

  # --- Sécurité & Accès ---
  configs:
    cm:
      kustomize.buildOptions: "--enable-alpha-plugins --enable-exec"
    params:
      server.insecure: true # Désactive TLS interne d'Argo

# --- Configuration Traefik Production & Sécurisée ---
traefik:
  # Pas de DaemonSet "hostNetwork" (trop dangereux/privilégié)
  deployment:
    kind: DaemonSet
    replicas: 2

  # Sécurité maximale (Respecte le standard 'Restricted')
  securityContext:
    capabilities:
      drop: [ALL] # On ne demande RIEN au kernel
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65532
    runAsGroup: 65532

  # Configuration Réseau
  service:
    enabled: true
    type: ClusterIP

    # Force Kubernetes à écouter sur la VIP du cluster
    externalIPs:
      - 192.168.1.9

  ports:
    web:
      port: 8000 # Port interne du conteneur (sécurisé)
      expose:
        default: true
      exposedPort: 80
    websecure:
      port: 8443
      expose:
        default: true
      exposedPort: 443 # https://192.168.1.9

  # Tolérances
  tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

  # Logs (Pour l'observabilité)
  logs:
    general:
      level: INFO
    access:
      enabled: true

cert-manager:
  installCRDs: true

  # Sécurité pour Talos
  securityContext:
    runAsNonRoot: true

  tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

  webhook:
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"

  cainjector:
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"

  startupapicheck:
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"

# CloudNative-PG Operator
cloudnative-pg:
  # Configuration de l'opérateur pour Talos
  tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

  # Ressources de l'opérateur
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Monitoring (optionnel)
  monitoring:
    podMonitor:
      enabled: false
